import { useEffect, useState } from "react"

const SERVER_ADDRESS = import.meta.env.VITE_API_URL
const GAUGE_CENTER_X = 80
const GAUGE_CENTER_Y = 80
const GAUGE_RADIUS = 60
const MAX_UV = 13

function UVReading() {
    const [uv, setUV] = useState(null)
    const [pointerX, setPointerX] = useState(0)
    const [pointerY, setPointerY] = useState(0)
    const [loading, setLoading] = useState(true);

    useEffect(() => {
        requestUV()
    }, [])

    useEffect(() => {
        calculatePosition();
    }, [uv]);

    const calculatePosition = () =>{
        // while (true){
        //     if (!loading || uv !== null) {
        //         break;
        //     }

        // }

        const clampedUv = Math.max(0, Math.min(uv, MAX_UV))
        const angleDegrees = 180 - (clampedUv / MAX_UV) * 180
        const angleRadians = (angleDegrees * Math.PI) / 180

        // SVG Y axis grows downward, so subtract the Y component.
        const x = GAUGE_CENTER_X + GAUGE_RADIUS * Math.cos(angleRadians)
        const y = GAUGE_CENTER_Y - GAUGE_RADIUS * Math.sin(angleRadians)

        setPointerX(x)
        setPointerY(y)
        console.error("PointerX: ", pointerX, "PointerY: ", pointerY)
    }

    const requestUV = async () => {
        setLoading(true);
        const url = new URL("/api/uv", SERVER_ADDRESS)
        const response = await fetch(url, {
            method: "GET",
        })

        if (!response.ok) {
            throw new Error("Network response was not ok")
        }
        let data
        try {
            data = await response.json()
        } catch (err) {
            const text = await response.text()
            console.error("Invalid JSON received from UV endpoint", text)
            throw err
        }

        const uvValue = typeof data === "number" ? data : data?.uv
        const parsedUv = uvValue == null ? null : Number(uvValue)
        setUV(Number.isFinite(parsedUv) ? parsedUv : null)
        setLoading(false);
    }

    return (
        <div>
            {/* {setAngle()} */}
            
            <svg viewBox="0 0 160 80" fill="none" xmlns="http://www.w3.org/2000/svg" className="injected-svg" data-src="/assets/svg/grapefruit.53996466.svg" xmlnsXlink="http://www.w3.org/1999/xlink">
                <g clipPath="url(#clip0-18)">
                    <path d="M160 80.0001C160 62.4444 154.351 46.1924 144.747 32.9822L80 80.0001H160Z" fill="#ED1C24"></path>
                    <path d="M15.2526 32.9822C5.6491 46.1489 0 62.401 0 80.0001H80L15.2526 32.9822Z" fill="#00B451"></path>
                    <path d="M80.0001 80L104.726 3.91092C96.9474 1.39055 88.6476 0 80.0001 0C71.3526 0 63.0528 1.34709 55.2744 3.91092L80.0001 80Z" fill="#FFE80E"></path>
                    <path d="M80 80L144.704 32.982C134.883 19.4677 120.934 9.1689 104.726 3.91089L80 80Z" fill="#FF8300"></path>
                    <path d="M79.9999 80L55.2742 3.91089C39.0656 9.1689 25.1166 19.4677 15.2959 32.982L79.9999 80Z" fill="#000F9F"></path>
                    <path d="M80.0433 12.1673C86.3877 12.1673 92.5582 13.0364 98.3811 14.6876L100.815 7.16999C94.253 5.04071 87.3002 3.91089 80.0433 3.91089C72.7864 3.91089 65.7902 5.04071 59.272 7.16999L61.7054 14.6876C67.5284 13.0364 73.6555 12.1673 80.0433 12.1673Z" fill="#231F20"></path>
                    <path d="M73.0474 6.60521L73.9165 6.56176 74.0468 8.21304 75.5243 8.12613 75.3939 6.47485 76.263 6.4314 76.5672 10.5596 75.6981 10.603 75.5677 8.86486 74.0903 8.95176 74.2206 10.6899 73.3515 10.7334 73.0474 6.60521zM77.3926 6.34448L78.2617 6.30103 78.392 10.4727 77.5229 10.5161 77.3926 6.34448zM79.2178 9.56012L79.2612 7.08321C79.2612 6.5183 79.522 6.25757 80.0869 6.25757H81.5209C82.0858 6.25757 82.3465 6.5183 82.3465 7.08321V7.64812H81.4774V7.17012C81.4774 7.08321 81.434 7.03975 81.3471 7.03975H80.2172C80.1303 7.03975 80.0869 7.08321 80.0869 7.17012L80.0434 9.51667C80.0434 9.60358 80.0869 9.64703 80.1738 9.64703H81.3036C81.3905 9.64703 81.434 9.60358 81.434 9.51667V8.86485H80.6518V8.12612H82.3031V9.60358C82.3031 10.1685 82.0423 10.4292 81.4774 10.4292H80.0434C79.4785 10.3858 79.2178 10.125 79.2178 9.56012zM83.4766 6.34448L84.3456 6.38794 84.2153 8.03921 85.6927 8.12612 85.8231 6.47485 86.6922 6.5183 86.4315 10.6465 85.5624 10.603 85.6927 8.86485 84.2153 8.77794 84.0849 10.5161 83.2158 10.4727 83.4766 6.34448z" fill="#fff"></path>
                    <path d="M39.7177 25.2037C44.8453 21.4666 50.3641 18.5551 56.0566 16.4693L53.6232 8.95166C47.0615 11.0809 40.7606 14.2531 34.8942 18.5117C29.0278 22.7702 24.0305 27.8544 19.9893 33.4166L26.3771 38.0663C30.1576 33.2863 34.59 28.9408 39.7177 25.2037Z" fill="#231F20"></path>
                    <path d="M24.4648 31.1571L25.1167 30.4618 27.637 31.3309 26.5941 28.854 27.2459 28.1587 30.2878 30.9832 29.7229 31.5916 27.8108 29.7665 28.7234 31.8523 28.2888 32.3303 26.1596 31.5482 28.0716 33.3732 27.5067 33.9816 24.4648 31.1571zM30.3749 29.7664L28.6802 27.9413C28.2891 27.5502 28.2891 27.1591 28.7236 26.768L29.8535 25.7251C30.2446 25.334 30.6357 25.334 31.0267 25.7686L32.7215 27.5937C33.1126 27.9848 33.1126 28.3758 32.678 28.7669L31.5482 29.8099C31.1571 30.2009 30.766 30.2009 30.3749 29.7664zM32.0262 28.2889C32.0697 28.2455 32.1131 28.202 32.0262 28.1151L30.4184 26.3769C30.3749 26.3335 30.3315 26.29 30.2446 26.3769L29.332 27.246C29.2886 27.2895 29.2451 27.3329 29.332 27.4198L30.9398 29.158C30.9833 29.2015 31.0267 29.2449 31.1137 29.158L32.0262 28.2889zM31.2871 24.3781L33.0253 22.9441C33.4598 22.5965 33.8509 22.5965 34.1986 23.031L35.8064 24.943C36.154 25.3776 36.154 25.7687 35.7195 26.1163L33.9813 27.5503 31.2871 24.3781zM35.1111 25.6383C35.198 25.5949 35.198 25.5514 35.1111 25.4645L33.5902 23.6394C33.5468 23.5525 33.5033 23.5525 33.4164 23.6394L32.4169 24.465 34.0682 26.464 35.1111 25.6383zM34.5029 21.7707L36.7626 20.1194 37.2406 20.7278 35.6762 21.901 36.1977 22.5963 37.4578 21.6403 37.9358 22.2487 36.6757 23.2047 37.2406 23.9869 38.8049 22.8136 39.2829 23.4219 37.0233 25.0732 34.5029 21.7707zM42.5422 21.2058L41.8035 21.7273 40.4129 20.9016 39.848 21.2927 40.6737 22.5094 39.9784 22.9874 37.6753 19.5111 39.5004 18.2943C39.9784 17.9902 40.326 18.0771 40.6737 18.5116L41.2386 19.3373C41.4993 19.7283 41.4993 20.0325 41.1951 20.3367L42.5422 21.2058zM40.4129 19.9891C40.4998 19.9456 40.4998 19.9022 40.4564 19.8153L39.9349 19.0331C39.8915 18.9462 39.848 18.9462 39.7611 18.9896L38.7617 19.6414 39.4135 20.5974 40.4129 19.9891zM44.6278 18.9027L43.411 19.6414 43.6283 20.554 42.8461 20.9885 41.8467 16.7734 42.933 16.1216 46.1052 19.0765 45.2796 19.5545 44.6278 18.9027zM44.0629 18.3378L42.7592 17.0776 43.2372 18.8158 44.0629 18.3378zM45.4101 15.6872L44.4106 16.2086 44.063 15.5133 46.8006 14.0793 47.1483 14.7746 46.1488 15.2961 47.7132 18.2944 46.9744 18.6855 45.4101 15.6872zM47.583 13.7316L50.1034 12.5583 50.451 13.2536 48.6694 14.0793 49.017 14.8614 50.451 14.2096 50.7552 14.9049 49.3212 15.5567 49.7123 16.4258 51.4939 15.6002 51.8416 16.2954 49.3212 17.4687 47.583 13.7316z" fill="#fff"></path>
                    <path d="M14.6879 59.7935C16.6433 53.7533 19.381 48.1911 22.7704 43.1504L16.3826 38.5007C12.3413 44.0629 9.08222 50.3638 6.86603 57.2297C4.64984 64.0955 3.56348 71.1352 3.56348 78.001H11.4722C11.646 71.9608 12.7324 65.8337 14.6879 59.7935Z" fill="#231F20"></path>
                    <path d="M7.30029 64.3998L7.51757 63.5742 10.7767 64.3563 11.2112 62.6182 11.9934 62.792 11.385 65.3558 7.30029 64.3998zM11.298 62.0966L8.90802 61.4013C8.38656 61.2275 8.16929 60.9233 8.34311 60.3584L8.77766 58.8809C8.95148 58.3595 9.25566 58.1422 9.82057 58.316L12.2106 59.0113C12.732 59.1851 12.9493 59.4893 12.7755 60.0542L12.3409 61.5317C12.1671 62.0966 11.8195 62.2704 11.298 62.0966zM11.9498 60.0107C11.9933 59.9238 11.9498 59.8804 11.8629 59.8804L9.60329 59.1851C9.51639 59.1416 9.47293 59.1851 9.47293 59.272L9.12529 60.4453C9.08184 60.5322 9.12529 60.5756 9.2122 60.5756L11.4718 61.2709C11.5588 61.3144 11.6022 61.2709 11.6022 61.184L11.9498 60.0107zM9.25586 57.4035L9.56004 56.5779 12.6453 57.0559 10.038 55.2743 10.2988 54.579 13.4275 54.9266 10.7768 53.2319 11.081 52.4497 14.6008 54.8832 14.2966 55.7088 11.5155 55.4046 13.8186 57.0124 13.471 57.8815 9.25586 57.4035z" fill="#fff"></path>
                    <path d="M120.239 25.1168C125.366 28.8539 129.842 33.1993 133.579 37.9359L139.967 33.2863C135.926 27.7241 130.929 22.6833 125.062 18.4248C119.196 14.1662 112.852 10.994 106.333 8.86475L103.9 16.3824C109.636 18.5117 115.111 21.3797 120.239 25.1168Z" fill="#231F20"></path>
                    <path d="M110.288 12.6453L111.157 13.0364 110.549 16.2955 112.678 13.7751 113.504 14.1662 110.549 17.3818 109.636 16.9473 110.288 12.6453zM114.242 14.5574L116.719 15.9045 116.328 16.5997 114.633 15.6872 114.242 16.4259 115.633 17.1647 115.285 17.8599 113.894 17.1212 113.46 17.9468 115.155 18.8594 114.764 19.5547 112.287 18.2076 114.242 14.5574zM118.11 21.5534L117.328 21.0754 117.501 19.4676 116.893 19.12 116.111 20.3802 115.372 19.9456 117.545 16.3823 119.413 17.5121C119.891 17.8163 119.978 18.164 119.674 18.642L119.153 19.5111C118.892 19.9021 118.631 20.0325 118.24 19.9021L118.11 21.5534zM118.327 19.0765C118.414 19.12 118.457 19.12 118.501 19.0331L118.979 18.2509C119.022 18.164 119.022 18.1205 118.935 18.0771L117.936 17.4687 117.328 18.4681 118.327 19.0765zM120.283 21.2928L120.717 18.251 121.499 18.7724 121.152 20.7713 122.933 19.7284 123.672 20.2499 121.021 21.7273 120.196 22.9006 119.5 22.4226 120.283 21.2928zM125.367 21.6404L126.018 22.1618 124.975 23.422 126.105 24.3346 127.148 23.0744 127.8 23.5958 125.193 26.8549 124.541 26.3335 125.627 24.9864 124.497 24.0738 123.411 25.4209 122.759 24.8995 125.367 21.6404zM128.713 24.3779L129.365 24.9428 126.627 28.0716 125.975 27.5067 128.713 24.3779zM127.887 28.0283L129.625 26.2032C130.016 25.8121 130.407 25.7686 130.798 26.1597L131.841 27.1592C132.232 27.5503 132.276 27.9413 131.885 28.3324L131.494 28.7235 130.885 28.1152 131.233 27.7675C131.276 27.7241 131.276 27.6806 131.233 27.5937L130.407 26.8115C130.364 26.7681 130.32 26.7681 130.233 26.8115L128.626 28.5063C128.582 28.5497 128.582 28.5932 128.626 28.6801L129.451 29.4623C129.495 29.5057 129.538 29.5057 129.625 29.4623L130.06 28.9843 129.495 28.4628 130.016 27.9413 131.189 29.0712 130.19 30.1141C129.799 30.5052 129.408 30.5486 129.017 30.1575L127.974 29.1581C127.496 28.8104 127.496 28.4193 127.887 28.0283zM133.145 28.5063L133.71 29.1147 132.493 30.2445 133.493 31.3309 134.709 30.2011 135.274 30.8094 132.232 33.634 131.667 33.0256 132.928 31.8524 131.928 30.766 130.668 31.9393 130.103 31.3309 133.145 28.5063z" fill="#fff"></path>
                    <path d="M145.226 59.5762C147.181 65.6164 148.267 71.7435 148.485 77.7837H156.393C156.393 70.9179 155.307 63.9217 153.091 57.0124C150.831 50.1031 147.616 43.8456 143.574 38.2834L137.187 42.9331C140.533 47.9738 143.27 53.536 145.226 59.5762Z" fill="#231F20"></path>
                    <path d="M145.443 45.2363L146.746 47.7132 146.051 48.0609 145.138 46.3227 144.356 46.7138 145.095 48.1043 144.4 48.452 143.661 47.0614 142.792 47.496 143.704 49.2342 143.009 49.5818 141.706 47.1049 145.443 45.2363zM145.66 50.277L147.007 48.2781 147.398 49.1472 146.529 50.4508 148.093 50.6246 148.485 51.4503 146.095 51.1026 144.704 53.1884 144.313 52.3194 145.225 50.9723 143.618 50.7984 143.227 49.9728 145.66 50.277zM148.354 53.2753L147.92 52.2324 148.659 51.9282 149.788 54.8397 149.05 55.1439 148.615 54.101 145.486 55.3611 145.182 54.579 148.354 53.2753zM147.181 59.9673L146.877 59.0982 148.05 57.9684 147.833 57.3166 146.442 57.7946 146.182 56.9689 150.136 55.6218 150.831 57.7076C151.005 58.2291 150.831 58.5767 150.31 58.7506L149.354 59.0547C148.919 59.1851 148.615 59.0982 148.398 58.7506L147.181 59.9673zM148.963 58.1856C149.006 58.2726 149.05 58.2726 149.093 58.2726L149.962 57.9684C150.049 57.9249 150.049 57.8815 150.049 57.838L149.658 56.7082 148.572 57.0993 148.963 58.1856zM151.396 59.5764L152.135 62.2706 151.396 62.4879 150.874 60.6193 150.049 60.8366 150.483 62.3575 149.745 62.5748 149.31 61.0539 148.397 61.3146 148.919 63.1831 148.18 63.4004 147.441 60.7062 151.396 59.5764zM152.395 63.3135L152.569 64.226 150.396 65.8338 153.004 66.3988 153.177 67.3113 149.093 68.1804 148.919 67.3548 151.526 66.7898 149.31 66.3553 149.18 65.7469 151.048 64.4433 148.441 65.0082 148.267 64.226 152.395 63.3135zM153.482 68.5281L153.873 71.3092 153.091 71.4395 152.786 69.5275 151.917 69.6579 152.135 71.2223 151.352 71.3526 151.135 69.7883 150.179 69.9186 150.483 71.8306 149.701 71.961 149.31 69.1799 153.482 68.5281z" fill="#fff"></path>
                    <line x1={GAUGE_CENTER_X} y1={GAUGE_CENTER_Y} x2={pointerX} y2={pointerY} stroke="#000000" strokeWidth="2" strokeLinecap="round" />
                </g>
                <defs>
                    <clipPath id="clip0-18">
                        <path fill="#fff" d="M0 0H160V80H0z"></path>
                    </clipPath>
                </defs>
            </svg>
        </div>
    )
}

export default UVReading
